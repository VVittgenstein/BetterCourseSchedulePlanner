# Compact - ST-20251113-act-008-02-filter-engine

## 已落实事实
- `api/src/queries/course_search.ts:89` 的 `executeCourseSearch` 负责解析 `/api/courses` 的 SQLite 查询：term/campus/subject 为基础 WHERE，从 `courses`/`course_core_attributes`/`sections`/`section_meetings`/`course_search_fts`/`subjects` 组合过滤，支持 level、courseNumber、核心代码、学分区间、hasOpenSection、instructor、requiresPermission、delivery、meetingDays+meetingStart/End，且全部使用参数化绑定。
- 最新修复（`api/src/queries/course_search.ts:153`）把 delivery 与 meeting 条件合并进同一个 `EXISTS` 子句并在需要时联接 `section_meetings`，确保只有同一 section 同时满足 delivery 和时间约束时课程才被返回，消除了“不同 section 混合命中”的误判。
- 排序/分页仍由 `resolveSort` 和 LIMIT/OFFSET 控制，并可选附加 subject 元数据与 section 汇总（`sectionsSummary`）；`api/src/routes/courses.ts:65` 已上线真实数据响应与 `meta.total/hasNext` 计算。
- `api/tests/course_search.test.ts:1` 的 node:test 套件会在内存 SQLite 中建表造数，覆盖核心组合筛选、FTS/pagination、include 扩展以及 requiresPermission 逻辑，回归验证交付。

## 接口 / 行为变更
- `/api/courses` 直接读取 SQLite 并返回真实课程列表；当请求同时指定 `delivery` 与 `meetingDays/meetingStart/meetingEnd` 时，只有同一个 section 同时满足两类过滤才会出现在结果里。

## 限制 / 风险 / TODO
- 依赖 `course_search_fts` 与 `subjects` 表的 JOIN/MATCH；若部署未完成迁移或 FTS 未构建，会导致查询报错，需要在 DB 发布流程中确保存在。
- `/api/sections` 仍是空实现（上一子任务遗留），ACT-008 后续里程碑仍需补充 section 级过滤。

## 自测
- `npx tsx api/tests/course_search.test.ts` ✅ 6 个 node:test 用例全部通过，覆盖 delivery+meeting 联合筛选及其他组合过滤。
